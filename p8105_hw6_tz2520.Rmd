---
title: "Homework 6"
auhor: "Tongtong Zhu"
date: "2022-12-1"
output: github_document
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(modelr)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 8,
  fig.height = 6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

## Problem 1

### Load dataset

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

### Bootstrap for r square and log value 

```{r}
boot_straps = 
  weather_df %>%
  bootstrap(n = 100, id = "strap_num") %>% 
  mutate(
    models = map(.x = strap, ~lm(tmax ~ tmin, data = .x)),
    results_r = map(models, broom::glance),
    results_log = map(models, broom::tidy)
  ) %>% 
  unnest(results_r,results_log) %>% 
  select(strap_num, term, estimate, r.squared) %>% 
  pivot_wider(
    names_from = term,
    values_from = estimate) %>% 
  rename(
    beta_0 = "(Intercept)",
    beta_1 = "tmin"
  ) %>% 
  mutate(
    log_beta = log(beta_0*beta_1)
  ) %>% 
  select(strap_num, r.squared, log_beta)
  
```

### Distribution of r square

```{r}
boot_straps %>% 
  ggplot(aes(x = r.squared)) +
  geom_density() +
  labs(
    title = "Distribution of r squared estimates",
    x = "r squared estimate"
  )
  
```

**Description of r squared estimates** 

This distribution of r squared estimates appears to follow a normal distribution, centered around 0.905.

### Distribution of log beta product

```{r}
boot_straps %>% 
  ggplot(aes(x = log_beta)) +
  geom_density() +
  labs(
    title = "Distribution of log(beta0*beta1) estimates",
    x = "log(beta0*beta1)"
  )
  
```

**Description of log beta product**

This distribution of log beta product appears to follow a normal distribution, centered around 2.02.

### 95% Confidence interval for r squared

```{r}
boot_straps %>% 
  summarize(
    ci_lower = quantile(r.squared, 0.025),
    ci_upper = quantile(r.squared, 0.975)
  )

```

### 95% Confidence interval for log beta product

```{r}
boot_straps %>% 
  summarize(
    ci_lower = quantile(log_beta, 0.025),
    ci_upper = quantile(log_beta, 0.975)
  )

```

## Problem 2

### Load homicide dataset

```{r}
homi_data = read_csv("./data/homicide-data.csv", show_col_types = FALSE)
```

### Create `city_state` and `resolved` variables

```{r}
homi_df =
  homi_data %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolved = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter((city_state != "Tulsa, AL"),
         (city_state != "Phoenix, AZ"),
         (city_state != "Kansas City, MO"),
         (city_state != "Dallas, TX"),
         (victim_race %in% c("White", "Black"))) %>% 
  mutate(
    victim_age = as.numeric(victim_age),
    victim_race = fct_relevel(victim_race, "White")
  ) %>% 
  select(city_state, resolved, victim_age, victim_race, victim_sex)
  
```

### Logistic regression for Baltimore

```{r}
baltimore_df =
  homi_df %>% 
  filter(city_state == "Baltimore, MD")

baltimore_logis =
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

baltimore_logis %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
    ) %>%
  select(term, OR, starts_with("CI")) %>%
  filter(term == "victim_sexMale") %>% 
  knitr::kable(digits = 3)
```

**Description of odds ratio for victim sex**

The adjusted odds ratio for solving homicides comparing male victims to female victims is 0.426, with a 95% confidence interval of (0.325,0.558), keeping all other variables fixed. This indicates that the odds of resolved homicides for male victim is 0.426 times the odds of resolved homicides for female victim, adjusting for victim age and victim race. Homicides in which the victim is male are significantly less like to be resolved than those in which the victim is female.

### Logistic regression for each city

```{r}
cities_logis_df =
  homi_df %>%
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~glm(resolved ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
    ) %>%
  select(city_state, term, OR, starts_with("CI")) %>%
  filter(term == "victim_sexMale") 
  
cities_logis_df %>% 
knitr::kable(digits = 3)

```

### Create a plot for OR and 95% CI for each city

```{r}
cities_logis_df %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    x = "City, State",
    y = "Estimated Odds Ratios\n(95% CI)",
    title = "ORs for Solved Homicides Comparing Male to Female with 95% CIs for Each City"
  )
  
```

**Comment on the plot**

Most of the cities have estimated OR less than 1, indicating homicides in which the victim is male are less like to be resolved than those in which the victim is female. Among all cities, New York, NY has the lowest estimated adjusted OR with a relatively narrow 95% CI, but Albuquerque, NM has the highest estimated adjusted OR with a relatively broad 95% CI.


